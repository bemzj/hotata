/**
 * 这是基于html5的前端图片工具，压缩工具。
 */
var ImageResizer=function(opts){var settings={resizeMode:"auto",dataSource:"",dataSourceType:"image",maxWidth:150,maxHeight:200,onTmpImgGenerate:function(img){},success:function(resizeImgBase64,canvas){},debug:false };var appData={};$.extend(settings,opts);var _debug=function(str,styles){if(settings.debug==true){if(styles){console.log(str,styles)}else{console.log(str)}}};var innerTools={getBase4FromImgFile:function(file,callBack){var reader=new FileReader();reader.onload=function(e){var base64Img=e.target.result;if(callBack){callBack(base64Img)}};reader.readAsDataURL(file)},getImgFromDataSource:function(datasource,dataSourceType,callback){var _me=this;var img1=new Image();if(dataSourceType=="img"||dataSourceType=="image"){img1.src=$(datasource).attr("src");if(callback){callback(img1)}}else if(dataSourceType=="base64"){img1.src=datasource;if(callback){callback(img1)}}else if(dataSourceType=="canvas"){img1.src=datasource.toDataURL("image/jpeg");if(callback){callback(img1)}}else if(dataSourceType=="file"){_me.getBase4FromImgFile(function(base64str){img1.src=base64str;if(callback){callback(img1)}})}},getResizeSizeFromImg:function(img){var _img_info={w:$(img)[0].naturalWidth,h:$(img)[0].naturalHeight};console.log("真实尺寸：");console.log(_img_info);var _resize_info={w:0,h:0};if(_img_info.w<=settings.maxWidth&&_img_info.h<=settings.maxHeight){return _img_info}if(settings.resizeMode=="auto"){var _percent_scale=parseFloat(_img_info.w/_img_info.h);var _size1={w:0,h:0};var _size_by_mw={w:settings.maxWidth,h:parseInt(settings.maxWidth/_percent_scale)};var _size_by_mh={w:parseInt(settings.maxHeight*_percent_scale),h:settings.maxHeight};if(_size_by_mw.h<=settings.maxHeight){return _size_by_mw}if(_size_by_mh.w<=settings.maxWidth){return _size_by_mh}return{w:settings.maxWidth,h:settings.maxHeight}}if(settings.resizeMode=="width"){if(_img_info.w<=settings.maxWidth){return _img_info}var _size_by_mw={w:settings.maxWidth,h:parseInt(settings.maxWidth/_percent_scale)};return _size_by_mw}if(settings.resizeMode=="height"){if(_img_info.h<=settings.maxHeight){return _img_info}var _size_by_mh={w:parseInt(settings.maxHeight*_percent_scale),h:settings.maxHeight};return _size_by_mh}},drawToCanvas:function(img,theW,theH,realW,realH,callback){var canvas=document.createElement("canvas");canvas.width=theW;canvas.height=theH;var ctx=canvas.getContext('2d');ctx.drawImage(img,0,0,realW,realH,0,0,theW,theH );var base64str=canvas.toDataURL("image/jpeg");if(callback){callback(base64str,canvas)}}};(function(){innerTools.getImgFromDataSource(settings.dataSource,settings.dataSourceType,function(_tmp_img){setTimeout(function(){var __tmpImg=_tmp_img;settings.onTmpImgGenerate(_tmp_img);var _limitSizeInfo=innerTools.getResizeSizeFromImg(__tmpImg);console.log(_limitSizeInfo);var _img_info={w:$(__tmpImg)[0].naturalWidth,h:$(__tmpImg)[0].naturalHeight};innerTools.drawToCanvas(__tmpImg,_limitSizeInfo.w,_limitSizeInfo.h,_img_info.w,_img_info.h,function(base64str,canvas){settings.success(base64str,canvas)})},1000)})})();var returnObject={};return returnObject};